const models = require("../models.js");
const express = require("express");
const axios = require("axios");
const config = require("../config");

const router = express.Router();

router.use((req, res, next) => {
  console.log("Time: ", Date.now());
  next();
});

router.post("/Vulnerabilities", async (req, res) => {
  let devices = req.body.devices;
  let cveData = [];
  for (let i = 0; i < devices.length; i++) {
    let product = devices[i].product;
    let vendorWords = devices[i].vendor
      .toLowerCase()
      .replace(/[\.,?!]/g, "")
      .split(" ");
    let vendor = "";
    for (let j = 0; j < vendorWords.length; j++) {
      vendor += vendorWords[j];
      console.log(vendor);
      await axios
        .get(`${config.cveURL}/vendors/${vendor}/products/${product}/cve`, {
          headers: { "Content-Type": "application/json" },
          auth: { username: config.cveUser, password: config.cvePassword },
        })
        .then((response) => {
          cveData[i] = response.data;
        })
        .catch((error) => {
          console.log(error);
        });
      if (cveData.length > 0) {
        break;
      }
    }
  }
  if (cveData.length === 0) {
    res.status(204);
  } else {
    res.status(200).send(cveData);
  }
});

module.exports = router;
