const express = require("express");
const axios = require("axios");
const config = require("/etc/secrets/config");
const models = require("./models.js");
const usbEnd = require("./routes/USBRoutes.js");
const cveEnd = require("./routes/CVERoutes.js");
const authEnd = require("./routes/AuthRoutes.js");
const userEnd = require("./routes/UserRoutes.js");
const scanEnd = require("./routes/ScanRoutes.js");
const cors = require("cors");
const cookieSession = require("cookie-session");

const app = express();

app.use(
  cookieSession({
    name: "session",
    keys: [config.secret], // should use as secret environment variable
    httpOnly: false,
  })
);

app.use(express.json());
app.use(cors(config.corsOptions));
app.use(express.urlencoded({ extended: true }));
// ROUTES
app.use("/USB", usbEnd);
app.use("/CVE", cveEnd);
app.use("/Auth", authEnd);
app.use("/User", userEnd);
app.use("/Scan", scanEnd);

app.get("/Health", (req, res) => {
  res.send("OK");
});

app.get("/CheckCVE", async (req, res) => {
  let cveData = "";
  await axios
    .get(`${config.cveURL}/cve/CVE-2021-1411`, {
      headers: { "Content-Type": "application/json" },
      auth: { username: config.cveUser, password: config.cvePassword },
    })
    .then((response) => {
      cveData = response.data;
    })
    .catch((error) => {
      console.log(error);
    });
  res.send(cveData);
});

app.get("/TestUSBdb", async (req, res) => {
  let usbData = "";
  models.USBVendor.sync();
  await models.USBVendor.findAll({
    where: {
      vendorids: "040a",
    },
  })
    .then((data) => {
      usbData = data.length !== 0 ? data : "No data found";
    })
    .catch((err) => {
      console.log(err);
      res.status(500).send({
        "error retrieving data": err.message || "Some error occurred.",
      });
    });
  res.send(usbData);
});

app.listen(3000, () => console.log("app running on port 3000"));
